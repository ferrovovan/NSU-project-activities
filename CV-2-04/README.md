# Задача CV-2-04


### Описание задачи
На основе CV-1-12 объединить маски для нескольких цветов (например, красный и синий).  
**Подробное руководство по воплощению задачи:**
1. Создайте маску для красного (CV-1-12).
2. Создайте маску для синего (аналогично, диапазон [100,100,100]–[130,255,255]).
3. Объедините маски с помощью cv2.bitwise_or().
4. Примените к изображению.
5. Отобразите результат.

Список используемых библиотек: **numpy**, **opencv**  
Источники данных: Синтетические данные  
Материалы для изучения:  
* [OpenCV Вводное руководство](https://docs.opencv.org/4.x/d3/df2/tutorial_py_basic_ops.html)
* [OpenCV bitwise_or()](https://docs.opencv.org/4.x/d2/de8/group__core__array.html#gab85523db362a4e26ff0c703793a719b4)
* [Алгоритм Уайлера — Атертона (EN)](https://en.wikipedia.org/wiki/Weiler–Atherton_clipping_algorithm)


### Требования
* Python 3.8 или выше  
  (используются f-строки и типовые аннотации).
* Библиотеки:  
  - numpy
  - opencv

##### Установка зависимостей
```bash
pip install -r requirements.txt
```

Для Arch Linux
```bash
sudo pacman -S python-opencv python-numpy
```


### Документация (описание воплощения)

Решение хранится в одном файле `combine_color_masks.py`.  
Данный код реализует задачу выделения и объединения цветовых масок (на основе принципов CV-1-12).  
В отличие от исходного задания, где способ создания красной маски был жёстко встроен в функцию, здесь решение обобщено и оформлено в виде контейнера `ColorMask`.  
Философия в том, что цвет — это не отдельный «жёсткий случай», а диапазон оттенков, и таких диапазонов у одного цвета может быть несколько.

---

#### Класс

- **`ColorMask`**  
    Контейнер для хранения диапазонов HSV, относящихся к одному цвету.  
    Поддерживает методы:
   + `add_hsv_range(hsv_range: tuple[np.ndarray, np.ndarray]) -> None` — добавляет диапазон оттенков для данного цвета.
   + `create_mask(image_hsv: np.ndarray) -> np.ndarray` — строит бинарную маску на основе всех сохранённых диапазонов.
   + `__iadd__(self, hsv_range)` — волшебный метод, позволяющий добавлять диапазоны через оператор `+=`.  
        Метод объединения самих масок (`__or__`) **сознательно не реализован**, так как объединение масок выполняется отдельной функцией, и смешивание ролей контейнера и логики обработки здесь не требуется.
        

---

#### Функции пяти шагов

- **`create_red_mask() -> ColorMask`**  
    Создание объекта `ColorMask` для красного цвета.  
    Красный цвет занимает два интервала по шкале HSV: `[0,100,100] – [10,255,255]` и `[170,100,100] – [180,255,255]`.  
    Оба диапазона добавляются в контейнер.
    
- **`create_blue_mask() -> ColorMask`**  
    Создание объекта `ColorMask` для синего цвета.  
    Диапазон задаётся `[100,100,100] – [130,255,255]`.
    
- **`combine_masks(masks: list[ColorMask], image_hsv: np.ndarray) -> np.ndarray`**  
    Агрегирует несколько `ColorMask`, создавая итоговую бинарную маску.  
    Для каждого контейнера строится маска, затем они объединяются через `cv2.bitwise_or`.  
    Таким образом, результат охватывает все заданные диапазоны сразу.
    
- **`apply_mask(image_bgr: np.ndarray, mask: np.ndarray) -> np.ndarray`**  
    Применяет итоговую маску к исходному BGR-изображению.  
    Белые области маски сохраняются, остальные пиксели зануляются.
    
- **`show_result(original: np.ndarray, mask: np.ndarray, result: np.ndarray) -> None`**  
    Отображает исходное изображение, итоговую маску и результат выделения цветов в трёх последовательных окнах.
    

---

#### Блоки примеров

- **`main_process_file(img_path: str)`**  
    Основная логика обработки файла: загрузка изображения, создание масок, объединение, применение и вывод результата.
    
- **`create_hue_gradient_python(width, height)`** и **`create_hue_gradient_numpy(width, height)`**  
    Создают синтетическое изображение с градиентом оттенков по шкале HSV, переводят его в формат BGR.  
    Первый вариант построен на чистом Python, второй — на векторизации с NumPy (значительно быстрее).
    
- **`example_synthetic()`**  
    Демонстрация работы на искусственно созданной HSV-шкале.  
    Наглядно показывает выделение красных и синих интервалов из полного спектра.


----

Для разбора аргументов командной строки используется модуль **argparse** с взаимоисключающей группой параметров.

---

Таким образом, код сохраняет методологическую основу CV-1-12 (работа с HSV, использование двух диапазонов для красного и объединение через `bitwise_or`), но обобщает подход, превращая его в расширяемую и аккуратную систему.


### Сценарии запуска
В программе реализованы два режима работы:

- `--example_synthetic` — генерация искусственного изображения с градиентом оттенков.  
    Используется для наглядной демонстрации построения и объединения масок.

- `--file <путь>` — обработка реального изображения, загруженного с диска.  
    На нём выделяются красные и синие области согласно заданным диапазонам HSV.


#### Примеры запуска

```bash
python3 combine_color_masks.py --example_synthetic
```

```bash
python3 combine_color_masks.py --file mypic.png
```

